<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åœ°å›¾</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #1a1a1a;
            overflow: hidden;
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        #canvasContainer {
            position: relative;
            width: 100vw;
            height: 100vh;
        }
        
        #imageCanvas {
            display: block;
            background: #2d2d2d;
            cursor: grab;
        }
        
        #imageCanvas:active {
            cursor: grabbing;
        }
        
        .loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            font-size: 18px;
        }
        
        .marker-info {
            position: absolute;
            background: rgba(0, 0, 0, 0.85);
            border: 1px solid #444;
            border-radius: 8px;
            padding: 15px;
            color: white;
            max-width: 300px;
            z-index: 100;
            display: none;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
            backdrop-filter: blur(10px);
        }
        
        .marker-info h3 {
            margin-bottom: 8px;
            color: #3498db;
        }
        
        .marker-info p {
            font-size: 14px;
            line-height: 1.4;
        }
        
        .close-btn {
            position: absolute;
            top: 5px;
            right: 10px;
            background: none;
            border: none;
            font-size: 18px;
            cursor: pointer;
            color: #7f8c8d;
        }
    </style>
</head>
<body>
    <div id="canvasContainer">
        <canvas id="imageCanvas"></canvas>
        <div class="loading" id="loadingText">åŠ è½½ä¸­...</div>
        <div class="marker-info" id="markerInfo">
            <button class="close-btn">&times;</button>
            <h3 id="markerTitle"></h3>
            <p id="markerDescription"></p>
        </div>
    </div>

    <script>
        // å…¨å±€å˜é‡
        let scale = 1;
        let minScale = 0.1;
        let maxScale = 5;
        let translateX = 0;
        let translateY = 0;
        let isDragging = false;
        let lastMouseX = 0;
        let lastMouseY = 0;
        let markers = [];
        let isAddingMarker = false;
        let currentImage = null;
        let hoveredButton = null;
        let hoveredMarker = null;
        
        // æŒ‰é’®å®šä¹‰
        const buttons = [
            { id: 'zoomIn', x: 20, y: 20, width: 40, height: 40, text: '+', tooltip: 'æ”¾å¤§' },
            { id: 'zoomOut', x: 70, y: 20, width: 40, height: 40, text: '-', tooltip: 'ç¼©å°' },
            { id: 'resetView', x: 120, y: 20, width: 40, height: 40, text: 'â†»', tooltip: 'é‡ç½®è§†å›¾' },
            { id: 'addMarker', x: 170, y: 20, width: 40, height: 40, text: 'ğŸ“Œ', tooltip: 'æ·»åŠ æ ‡è®°' }
        ];
        const icon_img = {
            shield: {
                url: "./icons/shield.png",
                width: 20,
                height: 20,
                loaded: false,
                image: null
            }
            ,
            point: {
                url: "./icons/point.png",
                width: 20,
                height: 20,
                loaded: false,
                image: null
            },
            monument:{
                url: "./icons/monument.png",
                width: 20,
                height: 20,
                loaded: false,
                image: null
            },
            treasure:{
                url: "./icons/treasure.png",
                width: 20,
                height: 20,
                loaded: false,
                image: null
            },
            wizard:{
                url: "./icons/wizard.png",
                width: 20,
                height: 20,
                loaded: false,
                image: null
            },
            gov:{
                url: "./icons/gov.png",
                width: 20,
                height: 20,
                loaded: false,
                image: null
            },
            temple:{
                url: "./icons/temple.png",
                width: 20,
                height: 20,
                loaded: false,
                image: null
            },
            idk:{
                url: "./icons/idk.png",
                width: 20,
                height: 20,
                loaded: false,
                image: null
            },
            dragon:{
                url: "./icons/dragon.png",
                width: 20,
                height: 20,
                loaded: false,
                image: null
            },
            dungeon:{
                url: "./icons/dungeon.png",
                width: 20,
                height: 20,
                loaded: false,
                image: null
            },
            castle:{
                url: "./icons/castle.png",
                width: 20,
                height: 20,
                loaded: false,
                image: null
            }
        };
        
        // DOMå…ƒç´ 
        const canvas = document.getElementById('imageCanvas');
        const ctx = canvas.getContext('2d');
        const loadingText = document.getElementById('loadingText');
        const markerInfo = document.getElementById('markerInfo');
        const markerTitle = document.getElementById('markerTitle');
        const markerDescription = document.getElementById('markerDescription');
        
        // åˆå§‹åŒ–Canvaså¤§å°
        function initCanvas() {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
        }
        
        // åŠ è½½å›¾ç‰‡
        function loadImage() {
            currentImage = new Image();
            currentImage.onload = function() {
                loadingText.style.display = 'none';
                draw();
            };
            currentImage.onerror = function() {
                loadingText.textContent = 'å›¾ç‰‡åŠ è½½å¤±è´¥ï¼Œä½¿ç”¨é»˜è®¤èƒŒæ™¯';
                currentImage = null;
                draw();
            };
            // æ›¿æ¢ä¸ºæ‚¨çš„å›¾ç‰‡è·¯å¾„
            currentImage.src = './map-erth.png';
        }
        // é¢„åŠ è½½æ‰€æœ‰æ ‡è®°å›¾ç‰‡
        function preloadMarkerIcons() {
            const iconPromises = [];
            
            for (const key in icon_img) {
                if (icon_img.hasOwnProperty(key)) {
                    const icon = icon_img[key];
                    icon.image = new Image();
                    icon.loaded = false;
                    
                    const promise = new Promise((resolve, reject) => {
                        icon.image.onload = () => {
                            icon.loaded = true;
                            resolve(icon);
                        };
                        icon.image.onerror = reject;
                    });
                    
                    icon.image.src = icon.url;
                    iconPromises.push(promise);
                }
            }
            
            return Promise.all(iconPromises);
        }
        // ç»˜åˆ¶æŒ‰é’®
        function drawButtons() {
            buttons.forEach(button => {
                const isHover = hoveredButton === button.id;
                const isActive = button.id === 'addMarker' && isAddingMarker;
                
                // æŒ‰é’®èƒŒæ™¯
                ctx.fillStyle = isActive ? '#e74c3c' : (isHover ? '#34495e' : 'rgba(52, 73, 94, 0.8)');
                ctx.fillRect(button.x, button.y, button.width, button.height);
                
                // æŒ‰é’®è¾¹æ¡†
                ctx.strokeStyle = isHover ? '#3498db' : 'rgba(255, 255, 255, 0.3)';
                ctx.lineWidth = 2;
                ctx.strokeRect(button.x, button.y, button.width, button.height);
                
                // æŒ‰é’®æ–‡å­—
                ctx.fillStyle = 'white';
                ctx.font = '18px Arial';
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                ctx.fillText(button.text, button.x + button.width / 2, button.y + button.height / 2);
                
                // æ‚¬åœæç¤º
                if (isHover) {
                    ctx.fillStyle = 'rgba(0, 0, 0, 0.8)';
                    ctx.fillRect(button.x, button.y + button.height + 5, 80, 25);
                    ctx.fillStyle = 'white';
                    ctx.font = '12px Arial';
                    ctx.fillText(button.tooltip, button.x + 40, button.y + button.height + 18);
                }
            });
        }
        
        // å°†å±å¹•åæ ‡è½¬æ¢ä¸ºå›¾ç‰‡åæ ‡
        function screenToImage(x, y) {
            const rect = canvas.getBoundingClientRect();
            const mouseX = x - rect.left;
            const mouseY = y - rect.top;
            
            const imgX = (mouseX - canvas.width / 2) / scale - translateX;
            const imgY = (mouseY - canvas.height / 2) / scale - translateY;
            
            const imgCenterX = currentImage ? currentImage.width / 2 : 0;
            const imgCenterY = currentImage ? currentImage.height / 2 : 0;
            
            return {
                x: imgX + imgCenterX,
                y: imgY + imgCenterY
            };
        }
        
        // å°†å›¾ç‰‡åæ ‡è½¬æ¢ä¸ºå±å¹•åæ ‡
        function imageToScreen(x, y) {
            const imgCenterX = currentImage ? currentImage.width / 2 : 0;
            const imgCenterY = currentImage ? currentImage.height / 2 : 0;
            
            const screenX = (x - imgCenterX) * scale + translateX * scale + canvas.width / 2;
            const screenY = (y - imgCenterY) * scale + translateY * scale + canvas.height / 2;
            
            return { x: screenX, y: screenY };
        }
        
        // æ£€æŸ¥æ˜¯å¦ç‚¹å‡»äº†æ ‡è®°
        function checkMarkerClick(x, y) {
            if (!currentImage) return null;
            
            const imgPos = screenToImage(x, y);
            const markerRadius = 30; // æ ‡è®°çš„ç‚¹å‡»åŠå¾„
            
            for (let i = markers.length - 1; i >= 0; i--) {
                const marker = markers[i];
                const distance = Math.sqrt(
                    Math.pow(imgPos.x - marker.x, 2) + 
                    Math.pow(imgPos.y - marker.y, 2)
                );
                
                // è€ƒè™‘ç¼©æ”¾å› ç´ è°ƒæ•´ç‚¹å‡»åŠå¾„
                const effectiveRadius = markerRadius / scale;
                if (distance < effectiveRadius) {
                    return marker;
                }
            }
            return null;
        }
        
        // æ£€æŸ¥é¼ æ ‡æ˜¯å¦æ‚¬åœåœ¨æ ‡è®°ä¸Š
        function checkMarkerHover(x, y) {
            if (!currentImage) return null;
            console.log('11');
            const imgPos = screenToImage(x, y);
            const markerRadius = 15; // æ ‡è®°çš„æ‚¬åœåŠå¾„
            
            for (let i = markers.length - 1; i >= 0; i--) {
                const marker = markers[i];
                const distance = Math.sqrt(
                    Math.pow(imgPos.x - marker.x, 2) + 
                    Math.pow(imgPos.y - marker.y, 2)
                );
                
                // è€ƒè™‘ç¼©æ”¾å› ç´ è°ƒæ•´æ‚¬åœåŠå¾„
                const effectiveRadius = markerRadius / scale;
                if (distance < effectiveRadius) {
                    return marker;
                }
            }
            return null;
        }
        
        // ç»˜åˆ¶å›¾ç‰‡å’Œæ ‡è®°
        function draw() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            // ä¿å­˜å½“å‰ç”»å¸ƒçŠ¶æ€
            ctx.save();
            
            // ç§»åŠ¨åˆ°ç”»å¸ƒä¸­å¿ƒ
            ctx.translate(canvas.width / 2, canvas.height / 2);
            
            // åº”ç”¨ç¼©æ”¾
            ctx.scale(scale, scale);
            
            // åº”ç”¨å¹³ç§»
            ctx.translate(translateX, translateY);
            
            // ç»˜åˆ¶å›¾ç‰‡ï¼ˆå¦‚æœå·²åŠ è½½ï¼‰
            if (currentImage) {
                ctx.drawImage(currentImage, -currentImage.width / 2, -currentImage.height / 2);
                
                // ç»˜åˆ¶æ ‡è®°
                markers.forEach(marker => {
                    const x = marker.x - currentImage.width / 2;
                    const y = marker.y - currentImage.height / 2;
                    const isHover = hoveredMarker === marker;
                    const screenPos = imageToScreen(marker.x, marker.y);
                    const icon = icon_img[marker.icontype];
                    
                    if (!icon.loaded) {
                        // æ ‡è®°ç‚¹
                        ctx.beginPath();
                        ctx.arc(x, y, 10, 0, Math.PI * 2);
                        ctx.fillStyle = isHover ? '#3498db' : '#e74c3c';
                        ctx.fill();
                        
                        // æ ‡è®°å¤–åœˆ
                        ctx.beginPath();
                        ctx.arc(x, y, 12, 0, Math.PI * 2);
                        ctx.strokeStyle = 'white';
                        ctx.lineWidth = 2;
                        ctx.stroke();
                    }
                    
                    ctx.drawImage(icon.image,  x - icon.width/scale/2, y - icon.height/scale/2, icon.width/scale, icon.height/scale);
                    // æ ‡è®°åç§°ï¼ˆåœ¨ç¼©æ”¾è¾ƒå¤§æ—¶æ˜¾ç¤ºï¼‰
                    if (scale > 0.5) {
                        ctx.fillStyle = '#2c3e50';
                        ctx.font = `${14 / scale}px Arial`;
                        ctx.textAlign = 'center';
                        ctx.fillText(marker.name, x, y + 20 / scale);
                    }
                });
            } else {
                // ç»˜åˆ¶é»˜è®¤èƒŒæ™¯
                ctx.fillStyle = '#34495e';
                ctx.fillRect(-canvas.width / 2, -canvas.height / 2, canvas.width, canvas.height);
                
                ctx.fillStyle = '#ecf0f1';
                ctx.font = '20px Arial';
                ctx.textAlign = 'center';
                ctx.fillText('è¯·è®¾ç½®æ­£ç¡®çš„å›¾ç‰‡è·¯å¾„', 0, 0);
            }
            
            // æ¢å¤ç”»å¸ƒçŠ¶æ€
            ctx.restore();
            
            // ç»˜åˆ¶æ§åˆ¶æŒ‰é’®ï¼ˆå§‹ç»ˆåœ¨é¡¶éƒ¨ï¼‰
            drawButtons();
            
            // ç»˜åˆ¶ç¼©æ”¾æ¯”ä¾‹ä¿¡æ¯
            ctx.fillStyle = 'rgba(0, 0, 0, 0.7)';
            ctx.fillRect(20, canvas.height - 40, 120, 30);
            ctx.fillStyle = 'white';
            ctx.font = '14px Arial';
            ctx.fillText(`ç¼©æ”¾: ${Math.round(scale * 100)}%`, 80, canvas.height - 25);
            
            // ç»˜åˆ¶æ“ä½œæç¤º
            if (isAddingMarker) {
                ctx.fillStyle = 'rgba(231, 76, 60, 0.8)';
                ctx.fillRect(canvas.width - 200, 20, 180, 30);
                ctx.fillStyle = 'white';
                ctx.font = '14px Arial';
                ctx.fillText('ç‚¹å‡»å›¾ç‰‡æ·»åŠ æ ‡è®°', canvas.width - 190, 40);
            }
        }
        
        // æ£€æŸ¥ç‚¹å‡»æ˜¯å¦åœ¨æŒ‰é’®ä¸Š
        function checkButtonClick(x, y) {
            for (const button of buttons) {
                if (x >= button.x && x <= button.x + button.width &&
                    y >= button.y && y <= button.y + button.height) {
                    return button.id;
                }
            }
            return null;
        }
        
        // æ£€æŸ¥é¼ æ ‡æ˜¯å¦åœ¨æŒ‰é’®ä¸Šæ‚¬åœ
        function checkButtonHover(x, y) {
            for (const button of buttons) {
                if (x >= button.x && x <= button.x + button.width &&
                    y >= button.y && y <= button.y + button.height) {
                    return button.id;
                }
            }
            return null;
        }
        
        // æ˜¾ç¤ºæ ‡è®°ä¿¡æ¯
        function showMarkerInfo(marker, x, y) {
            markerTitle.textContent = marker.name;
            markerDescription.textContent = marker.description;
            
            // å®šä½ä¿¡æ¯æ¡†ï¼Œç¡®ä¿ä¸è¶…å‡ºå±å¹•
            let infoX = x + 10;
            let infoY = y + 10;
            
            if (infoX + 300 > window.innerWidth) {
                infoX = x - 310;
            }
            if (infoY + 150 > window.innerHeight) {
                infoY = y - 160;
            }
            
            markerInfo.style.left = infoX + 'px';
            markerInfo.style.top = infoY + 'px';
            markerInfo.style.display = 'block';
        }
        
        // é¼ æ ‡æ»šè½®ç¼©æ”¾
        canvas.addEventListener('wheel', function(e) {
            e.preventDefault();
            
            const rect = canvas.getBoundingClientRect();
            const mouseX = e.clientX - rect.left;
            const mouseY = e.clientY - rect.top;
            
            const imgX = (mouseX - canvas.width / 2) / scale - translateX;
            const imgY = (mouseY - canvas.height / 2) / scale - translateY;
            
            const zoomIntensity = 0.1;
            const wheel = e.deltaY < 0 ? 1 : -1;
            const newScale = scale * Math.pow(1 + zoomIntensity, wheel);
            
            scale = Math.max(minScale, Math.min(maxScale, newScale));
            
            translateX = (mouseX - canvas.width / 2) / scale - imgX;
            translateY = (mouseY - canvas.height / 2) / scale - imgY;
            
            draw();
        });
        
        // é¼ æ ‡äº‹ä»¶å¤„ç†
        canvas.addEventListener('mousedown', function(e) {
            const rect = canvas.getBoundingClientRect();
            const mouseX = e.clientX - rect.left;
            const mouseY = e.clientY - rect.top;
            
            // æ£€æŸ¥æ˜¯å¦ç‚¹å‡»äº†æŒ‰é’®
            const clickedButton = checkButtonClick(mouseX, mouseY);
            if (clickedButton) {
                handleButtonClick(clickedButton);
                return;
            }
            
            // æ£€æŸ¥æ˜¯å¦ç‚¹å‡»äº†æ ‡è®°
            const clickedMarker = checkMarkerClick(e.clientX, e.clientY);
            if (clickedMarker) {
                showMarkerInfo(clickedMarker, e.clientX, e.clientY);
                return;
            }
            
            // æ·»åŠ æ ‡è®°æ¨¡å¼
            if (isAddingMarker) {
                addMarkerAtPosition(e);
                return;
            }
            
            // å¼€å§‹æ‹–æ‹½
            isDragging = true;
            lastMouseX = e.clientX;
            lastMouseY = e.clientY;
            canvas.style.cursor = 'grabbing';
        });
        
        canvas.addEventListener('mousemove', function(e) {
            const rect = canvas.getBoundingClientRect();
            const mouseX = e.clientX - rect.left;
            const mouseY = e.clientY - rect.top;
            
            // æ›´æ–°æŒ‰é’®æ‚¬åœçŠ¶æ€
            hoveredButton = checkButtonHover(mouseX, mouseY);
            
            // æ›´æ–°æ ‡è®°æ‚¬åœçŠ¶æ€
            hoveredMarker = checkMarkerHover(e.clientX, e.clientY);
            
            // æ›´æ–°å…‰æ ‡æ ·å¼
            if (hoveredButton) {
                canvas.style.cursor = 'pointer';
            } else if (hoveredMarker) {
                canvas.style.cursor = 'pointer';
            } else if (isAddingMarker) {
                canvas.style.cursor = 'crosshair';
            } else if (isDragging) {
                canvas.style.cursor = 'grabbing';
            } else {
                canvas.style.cursor = 'grab';
            }
            
            if (isDragging) {
                const deltaX = e.clientX - lastMouseX;
                const deltaY = e.clientY - lastMouseY;
                
                translateX += deltaX / scale;
                translateY += deltaY / scale;
                
                lastMouseX = e.clientX;
                lastMouseY = e.clientY;
                
                draw();
            } else {
                draw(); // æ›´æ–°æ‚¬åœæ•ˆæœ
            }
        });
        
        canvas.addEventListener('mouseup', function() {
            isDragging = false;
            canvas.style.cursor = hoveredButton || hoveredMarker ? 'pointer' : (isAddingMarker ? 'crosshair' : 'grab');
        });
        
        canvas.addEventListener('mouseout', function() {
            hoveredButton = null;
            hoveredMarker = null;
            if (!isDragging) {
                draw();
            }
        });
        
        // æŒ‰é’®ç‚¹å‡»å¤„ç†
        function handleButtonClick(buttonId) {
            switch(buttonId) {
                case 'zoomIn':
                    scale = Math.min(maxScale, scale + 0.2);
                    break;
                case 'zoomOut':
                    scale = Math.max(minScale, scale - 0.2);
                    break;
                case 'resetView':
                    scale = 1;
                    translateX = 0;
                    translateY = 0;
                    break;
                case 'addMarker':
                    isAddingMarker = !isAddingMarker;
                    break;
            }
            draw();
        }
        
        // æ·»åŠ æ ‡è®°
        function addMarkerAtPosition(e) {
            const imgPos = screenToImage(e.clientX, e.clientY);
            console.log(imgPos);
            const markerName = `æ ‡è®° ${markers.length + 1}`;
            const markerDesc = prompt('è¯·è¾“å…¥æ ‡è®°æè¿°:', `è¿™æ˜¯æ ‡è®° ${markers.length + 1}`);
            
            if (markerDesc !== null) {
                markers.push({
                    x: imgPos.x,
                    y: imgPos.y,
                    name: markerName,
                    description: markerDesc
                });
            }
            
            isAddingMarker = false;
            draw();
        }
        
        // å…³é—­æ ‡è®°ä¿¡æ¯
        document.querySelector('.close-btn').addEventListener('click', function() {
            markerInfo.style.display = 'none';
        });
        
        // åˆå§‹åŒ–
        window.addEventListener('load', function() {
            initCanvas();
            loadImage();
            preloadMarkerIcons().then(() => {
                console.log('æ‰€æœ‰æ ‡è®°å›¾ç‰‡åŠ è½½å®Œæˆ');
                loadImage();
            }).catch(error => {
                console.error('æ ‡è®°å›¾ç‰‡åŠ è½½å¤±è´¥:', error);
                loadImage();
            });
            // æ·»åŠ ç¤ºä¾‹æ ‡è®°
            markers.push(
                { x: 2825, y: 905, icontype:"point",name: "ä½©æ–‡å°¼ç‰¹", description: "è‰¾ç‰¹ç³èä»¥åŒ—çš„æµ·æ»¨å°é•‡ï¼Œä»¥ä¸å†»æ¸¯é—»åï¼Œå¦‚ä»Šä»ç„¶ä¿æŒç€æ”¿æ²»ç‹¬ç«‹ã€‚æ­¤åœ°ç”Ÿäº§å°éº¦ç­‰å†œä½œç‰©ï¼Œäººæ°‘çš†çƒ­æƒ…å¥½å®¢ï¼Œæ— å¿§æ— è™‘ï¼Œä¸€å¤©è¦åƒ6é¡¿é¥­ï¼Œä¸”å—œé…’å¦‚å‘½ï¼Œå„ç§åº†ç¥æ´»åŠ¨å¤šå¦‚ç‰›æ¯›ã€‚" },
                { x: 2856, y: 931, icontype:"idk",name: "æ— åå‰å“¨ç«™", description: "ç­äº¡çš„ä¸¹å¡”å°”çš„è¾¹å¢ƒå‰å“¨ç«™ï¼Œåœ¨ç‹‚é¾™æ³£è¡€ä¹‹å¹´ä¾¿è¢«åºŸå¼ƒã€‚æœ€è¿‘ä½©æ–‡å°¼ç‰¹çªç„¶å‡ºç°äº†ä¸€äº›ä¼ é—»ï¼šæœ‰äººåœ¨å‰å“¨ç«™é™„è¿‘å¤±è¸ªäº†ï¼Œé•‡ä¸Šçš„å…¶ä»–äººå»å¯»æ‰¾ï¼Œå´ä¸€æ— æ‰€è·ã€‚" }
            );
            
            // çª—å£å¤§å°å˜åŒ–æ—¶è°ƒæ•´Canvas
            window.addEventListener('resize', function() {
                initCanvas();
                draw();
            });
        });
    </script>
</body>

</html>




